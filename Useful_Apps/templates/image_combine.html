<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>画像結合 - UsefulApp</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .upload-area {
            border: 2px dashed #007bff;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            background-color: #f8f9fa;
            transition: background-color 0.3s ease;
        }
        .upload-area:hover {
            background-color: #e9ecef;
        }
        .upload-area.dragover {
            background-color: #e3f2fd;
            border-color: #2196f3;
        }
        .image-preview {
            max-width: 150px;
            max-height: 150px;
            object-fit: contain;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .image-item {
            position: relative;
            display: inline-block;
            margin: 10px;
        }
        .remove-btn {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            font-size: 12px;
            cursor: pointer;
        }
        .move-btn {
            position: absolute;
            bottom: -5px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 2px 6px;
            font-size: 10px;
            cursor: pointer;
        }
        .combined-preview {
            max-width: 100%;
            max-height: 500px;
            object-fit: contain;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand fw-bold" href="{% url 'home' %}">UsefulApp</a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="{% url 'home' %}">ホーム</a>
                <a class="nav-link active" href="{% url 'image_combine' %}">画像結合</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-md-12">
                <h2 class="mb-4">🖼️ 画像結合ツール</h2>
                
                <!-- アップロードエリア -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">1. 画像をアップロード</h5>
                    </div>
                    <div class="card-body">
                        <form id="imageForm" method="post" enctype="multipart/form-data">
                            {% csrf_token %}
                            <div class="upload-area" id="uploadArea">
                                <input type="file" id="imageInput" name="images" multiple accept="image/*" style="display: none;">
                                <div class="upload-content">
                                    <i class="fas fa-cloud-upload-alt fa-3x text-primary mb-3"></i>
                                    <h5>画像をドラッグ&ドロップ または クリックして選択</h5>
                                    <p class="text-muted">複数の画像を一度に選択できます（JPG, PNG, BMP, TIFF対応）</p>
                                    <button type="button" class="btn btn-primary" onclick="document.getElementById('imageInput').click()">
                                        画像を選択
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- 選択された画像一覧 -->
                <div class="card mb-4" id="imageListCard" style="display: none;">
                    <div class="card-header">
                        <h5 class="mb-0">2. 選択された画像 <span id="imageCount" class="badge bg-primary">0</span></h5>
                    </div>
                    <div class="card-body">
                        <div id="imageList" class="mb-3"></div>
                        <button type="button" class="btn btn-danger btn-sm" onclick="clearImages()">全て削除</button>
                    </div>
                </div>

                <!-- 結合設定 -->
                <div class="card mb-4" id="settingsCard" style="display: none;">
                    <div class="card-header">
                        <h5 class="mb-0">3. 結合設定</h5>
                    </div>
                    <div class="card-body">
                        <form id="combineForm">
                            {% csrf_token %}
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">結合方向</label>
                                    <div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="direction" value="horizontal" id="horizontal" checked>
                                            <label class="form-check-label" for="horizontal">横並び</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="direction" value="vertical" id="vertical">
                                            <label class="form-check-label" for="vertical">縦並び</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="direction" value="grid" id="grid">
                                            <label class="form-check-label" for="grid">グリッド</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6" id="gridSettings" style="display: none;">
                                    <label for="gridCols" class="form-label">グリッド列数</label>
                                    <input type="number" class="form-control" id="gridCols" name="grid_cols" value="2" min="1" max="10">
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-12">
                                    <label class="form-label">サイズ調整</label>
                                    <div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="resize_method" value="min" id="resizeMin" checked>
                                            <label class="form-check-label" for="resizeMin">最小サイズに統一</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="resize_method" value="max" id="resizeMax">
                                            <label class="form-check-label" for="resizeMax">最大サイズに統一</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="resize_method" value="fixed" id="resizeFixed">
                                            <label class="form-check-label" for="resizeFixed">固定サイズ</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mb-3" id="fixedSizeSettings" style="display: none;">
                                <div class="col-md-3">
                                    <label for="fixedWidth" class="form-label">幅 (px)</label>
                                    <input type="number" class="form-control" id="fixedWidth" name="fixed_width" value="300" min="1">
                                </div>
                                <div class="col-md-3">
                                    <label for="fixedHeight" class="form-label">高さ (px)</label>
                                    <input type="number" class="form-control" id="fixedHeight" name="fixed_height" value="300" min="1">
                                </div>
                            </div>
                            
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-info" onclick="previewCombination()">プレビュー</button>
                                <button type="button" class="btn btn-success" onclick="combineImages()">結合実行</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- プレビュー結果 -->
                <div class="card mb-4" id="previewCard" style="display: none;">
                    <div class="card-header">
                        <h5 class="mb-0">4. プレビュー結果</h5>
                    </div>
                    <div class="card-body text-center">
                        <div id="previewContent"></div>
                        <div id="previewInfo" class="mt-3"></div>
                    </div>
                </div>

                <!-- 結合結果 -->
                <div class="card mb-4" id="resultCard" style="display: none;">
                    <div class="card-header">
                        <h5 class="mb-0">5. 結合完了</h5>
                    </div>
                    <div class="card-body text-center">
                        <div id="resultContent"></div>
                        <div id="downloadSection" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let selectedImages = [];
        let imageOrder = 0;

        // ドラッグ&ドロップ機能
        const uploadArea = document.getElementById('uploadArea');
        const imageInput = document.getElementById('imageInput');

        uploadArea.addEventListener('click', () => imageInput.click());

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files).filter(file => file.type.startsWith('image/'));
            handleImageFiles(files);
        });

        imageInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            handleImageFiles(files);
        });

        // 画像ファイル処理
        function handleImageFiles(files) {
            files.forEach(file => {
                if (!selectedImages.find(img => img.file.name === file.name && img.file.size === file.size)) {
                    const imageObj = {
                        file: file,
                        id: imageOrder++,
                        url: URL.createObjectURL(file)
                    };
                    selectedImages.push(imageObj);
                }
            });
            updateImageList();
        }

        // 画像リスト更新
        function updateImageList() {
            const imageList = document.getElementById('imageList');
            const imageCount = document.getElementById('imageCount');
            const imageListCard = document.getElementById('imageListCard');
            const settingsCard = document.getElementById('settingsCard');

            imageCount.textContent = selectedImages.length;

            if (selectedImages.length > 0) {
                imageListCard.style.display = 'block';
                settingsCard.style.display = 'block';
                
                imageList.innerHTML = selectedImages.map((img, index) => `
                    <div class="image-item">
                        <img src="${img.url}" class="image-preview" alt="画像${index + 1}">
                        <button class="remove-btn" onclick="removeImage(${img.id})" title="削除">×</button>
                        <div style="position: absolute; bottom: -25px; left: 0; right: 0; text-align: center;">
                            <button class="move-btn" onclick="moveImage(${img.id}, -1)" ${index === 0 ? 'disabled' : ''}>↑</button>
                            <button class="move-btn" onclick="moveImage(${img.id}, 1)" ${index === selectedImages.length - 1 ? 'disabled' : ''}>↓</button>
                        </div>
                        <div style="margin-top: 30px; text-align: center; font-size: 12px;">${img.file.name}</div>
                    </div>
                `).join('');
            } else {
                imageListCard.style.display = 'none';
                settingsCard.style.display = 'none';
            }
        }

        // 画像削除
        function removeImage(id) {
            selectedImages = selectedImages.filter(img => img.id !== id);
            updateImageList();
        }

        // 画像順序変更
        function moveImage(id, direction) {
            const index = selectedImages.findIndex(img => img.id === id);
            if (index === -1) return;
            
            const newIndex = index + direction;
            if (newIndex < 0 || newIndex >= selectedImages.length) return;
            
            [selectedImages[index], selectedImages[newIndex]] = [selectedImages[newIndex], selectedImages[index]];
            updateImageList();
        }

        // 全画像削除
        function clearImages() {
            selectedImages.forEach(img => URL.revokeObjectURL(img.url));
            selectedImages = [];
            updateImageList();
            document.getElementById('previewCard').style.display = 'none';
            document.getElementById('resultCard').style.display = 'none';
        }

        // 設定変更時の表示制御
        document.querySelectorAll('input[name="direction"]').forEach(radio => {
            radio.addEventListener('change', () => {
                document.getElementById('gridSettings').style.display = 
                    radio.value === 'grid' ? 'block' : 'none';
            });
        });

        document.querySelectorAll('input[name="resize_method"]').forEach(radio => {
            radio.addEventListener('change', () => {
                document.getElementById('fixedSizeSettings').style.display = 
                    radio.value === 'fixed' ? 'block' : 'none';
            });
        });

        // プレビュー機能
        function previewCombination() {
            if (selectedImages.length === 0) {
                alert('画像を選択してください');
                return;
            }
            performCombination(true);
        }

        // 結合実行
        function combineImages() {
            if (selectedImages.length === 0) {
                alert('画像を選択してください');
                return;
            }
            performCombination(false);
        }

        // 結合処理
        function performCombination(isPreview) {
            const formData = new FormData();
            
            // 画像ファイルを順序通りに追加
            selectedImages.forEach((img, index) => {
                formData.append('images', img.file);
            });
            
            // 設定を追加
            formData.append('direction', document.querySelector('input[name="direction"]:checked').value);
            formData.append('resize_method', document.querySelector('input[name="resize_method"]:checked').value);
            formData.append('grid_cols', document.getElementById('gridCols').value);
            formData.append('fixed_width', document.getElementById('fixedWidth').value);
            formData.append('fixed_height', document.getElementById('fixedHeight').value);
            formData.append('is_preview', isPreview);
            formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

            fetch('{% url "image_combine" %}', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (isPreview) {
                        showPreview(data);
                    } else {
                        showResult(data);
                    }
                } else {
                    alert('エラー: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('処理中にエラーが発生しました');
            });
        }

        // プレビュー表示
        function showPreview(data) {
            const previewCard = document.getElementById('previewCard');
            const previewContent = document.getElementById('previewContent');
            const previewInfo = document.getElementById('previewInfo');
            
            previewContent.innerHTML = `<img src="data:image/jpeg;base64,${data.image_data}" class="combined-preview" alt="プレビュー">`;
            previewInfo.innerHTML = `
                <p class="text-muted">結合後サイズ: ${data.width} × ${data.height} ピクセル</p>
                <div class="mt-3">
                    <div class="row justify-content-center mb-3">
                        <div class="col-md-6">
                            <label for="previewFileName" class="form-label">ファイル名（プレビューから保存）</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="previewFileName" value="preview_image" placeholder="ファイル名を入力">
                                <select class="form-select" id="previewFormat" style="max-width: 120px;">
                                    <option value="jpg">.jpg</option>
                                    <option value="png">.png</option>
                                    <option value="bmp">.bmp</option>
                                    <option value="tiff">.tiff</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="downloadFromPreview('${data.image_data}')">
                        <i class="fas fa-download"></i> プレビューから保存
                    </button>
                </div>
            `;
            previewCard.style.display = 'block';
        }

        // プレビューからダウンロード
        function downloadFromPreview(imageData) {
            const fileName = document.getElementById('previewFileName').value || 'preview_image';
            const format = document.getElementById('previewFormat').value;
            const fullFileName = `${fileName}.${format}`;
            
            // ファイル名の検証
            if (!fileName.trim()) {
                alert('ファイル名を入力してください');
                return;
            }
            
            // 不正な文字をチェック
            const invalidChars = /[<>:"/\\|?*]/;
            if (invalidChars.test(fileName)) {
                alert('ファイル名に使用できない文字が含まれています\n使用できない文字: < > : " / \\ | ? *');
                return;
            }
            
            const link = document.createElement('a');
            link.href = `data:image/${format === 'jpg' ? 'jpeg' : format};base64,${imageData}`;
            link.download = fullFileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // 結果表示
        function showResult(data) {
            const resultCard = document.getElementById('resultCard');
            const resultContent = document.getElementById('resultContent');
            const downloadSection = document.getElementById('downloadSection');
            
            resultContent.innerHTML = `<img src="data:image/jpeg;base64,${data.image_data}" class="combined-preview" alt="結合結果">`;
            downloadSection.innerHTML = `
                <p class="text-success">✅ 画像の結合が完了しました！</p>
                <p class="text-muted">結合後サイズ: ${data.width} × ${data.height} ピクセル</p>
                <div class="row justify-content-center mb-3">
                    <div class="col-md-6">
                        <label for="downloadFileName" class="form-label">ファイル名</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="downloadFileName" value="combined_image" placeholder="ファイル名を入力">
                            <select class="form-select" id="downloadFormat" style="max-width: 120px;">
                                <option value="jpg">.jpg</option>
                                <option value="png">.png</option>
                                <option value="bmp">.bmp</option>
                                <option value="tiff">.tiff</option>
                            </select>
                        </div>
                    </div>
                </div>
                <button type="button" class="btn btn-primary" onclick="downloadImage('${data.image_data}')">
                    <i class="fas fa-download"></i> 画像をダウンロード
                </button>
            `;
            resultCard.style.display = 'block';
        }

        // 画像ダウンロード機能
        function downloadImage(imageData) {
            const fileName = document.getElementById('downloadFileName').value || 'combined_image';
            const format = document.getElementById('downloadFormat').value;
            const fullFileName = `${fileName}.${format}`;
            
            // ファイル名の検証
            if (!fileName.trim()) {
                alert('ファイル名を入力してください');
                return;
            }
            
            // 不正な文字をチェック
            const invalidChars = /[<>:"/\\|?*]/;
            if (invalidChars.test(fileName)) {
                alert('ファイル名に使用できない文字が含まれています\n使用できない文字: < > : " / \\ | ? *');
                return;
            }
            
            const link = document.createElement('a');
            link.href = `data:image/${format === 'jpg' ? 'jpeg' : format};base64,${imageData}`;
            link.download = fullFileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>
