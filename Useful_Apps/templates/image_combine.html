<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”»åƒçµåˆ - UsefulApp</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .upload-area {
            border: 2px dashed #007bff;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            background-color: #f8f9fa;
            transition: background-color 0.3s ease;
        }
        .upload-area:hover {
            background-color: #e9ecef;
        }
        .upload-area.dragover {
            background-color: #e3f2fd;
            border-color: #2196f3;
        }
        .image-preview {
            max-width: 150px;
            max-height: 150px;
            object-fit: contain;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .image-item {
            position: relative;
            display: inline-block;
            margin: 10px;
        }
        .remove-btn {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            font-size: 12px;
            cursor: pointer;
        }
        .move-btn {
            position: absolute;
            bottom: -5px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 2px 6px;
            font-size: 10px;
            cursor: pointer;
        }
        .combined-preview {
            max-width: 100%;
            max-height: 500px;
            object-fit: contain;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand fw-bold" href="{% url 'home' %}">UsefulApp</a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="{% url 'home' %}">ãƒ›ãƒ¼ãƒ </a>
                <a class="nav-link active" href="{% url 'image_combine' %}">ç”»åƒçµåˆ</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-md-12">
                <h2 class="mb-4">ğŸ–¼ï¸ ç”»åƒçµåˆãƒ„ãƒ¼ãƒ«</h2>
                
                <!-- ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒªã‚¢ -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">1. ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h5>
                    </div>
                    <div class="card-body">
                        <form id="imageForm" method="post" enctype="multipart/form-data">
                            {% csrf_token %}
                            <div class="upload-area" id="uploadArea">
                                <input type="file" id="imageInput" name="images" multiple accept="image/*" style="display: none;">
                                <div class="upload-content">
                                    <i class="fas fa-cloud-upload-alt fa-3x text-primary mb-3"></i>
                                    <h5>ç”»åƒã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ— ã¾ãŸã¯ ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠ</h5>
                                    <p class="text-muted">è¤‡æ•°ã®ç”»åƒã‚’ä¸€åº¦ã«é¸æŠã§ãã¾ã™ï¼ˆJPG, PNG, BMP, TIFFå¯¾å¿œï¼‰</p>
                                    <button type="button" class="btn btn-primary" onclick="document.getElementById('imageInput').click()">
                                        ç”»åƒã‚’é¸æŠ
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- é¸æŠã•ã‚ŒãŸç”»åƒä¸€è¦§ -->
                <div class="card mb-4" id="imageListCard" style="display: none;">
                    <div class="card-header">
                        <h5 class="mb-0">2. é¸æŠã•ã‚ŒãŸç”»åƒ <span id="imageCount" class="badge bg-primary">0</span></h5>
                    </div>
                    <div class="card-body">
                        <div id="imageList" class="mb-3"></div>
                        <button type="button" class="btn btn-danger btn-sm" onclick="clearImages()">å…¨ã¦å‰Šé™¤</button>
                    </div>
                </div>

                <!-- çµåˆè¨­å®š -->
                <div class="card mb-4" id="settingsCard" style="display: none;">
                    <div class="card-header">
                        <h5 class="mb-0">3. çµåˆè¨­å®š</h5>
                    </div>
                    <div class="card-body">
                        <form id="combineForm">
                            {% csrf_token %}
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">çµåˆæ–¹å‘</label>
                                    <div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="direction" value="horizontal" id="horizontal" checked>
                                            <label class="form-check-label" for="horizontal">æ¨ªä¸¦ã³</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="direction" value="vertical" id="vertical">
                                            <label class="form-check-label" for="vertical">ç¸¦ä¸¦ã³</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="direction" value="grid" id="grid">
                                            <label class="form-check-label" for="grid">ã‚°ãƒªãƒƒãƒ‰</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6" id="gridSettings" style="display: none;">
                                    <label for="gridCols" class="form-label">ã‚°ãƒªãƒƒãƒ‰åˆ—æ•°</label>
                                    <input type="number" class="form-control" id="gridCols" name="grid_cols" value="2" min="1" max="10">
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-12">
                                    <label class="form-label">ã‚µã‚¤ã‚ºèª¿æ•´</label>
                                    <div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="resize_method" value="min" id="resizeMin" checked>
                                            <label class="form-check-label" for="resizeMin">æœ€å°ã‚µã‚¤ã‚ºã«çµ±ä¸€</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="resize_method" value="max" id="resizeMax">
                                            <label class="form-check-label" for="resizeMax">æœ€å¤§ã‚µã‚¤ã‚ºã«çµ±ä¸€</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="resize_method" value="fixed" id="resizeFixed">
                                            <label class="form-check-label" for="resizeFixed">å›ºå®šã‚µã‚¤ã‚º</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mb-3" id="fixedSizeSettings" style="display: none;">
                                <div class="col-md-3">
                                    <label for="fixedWidth" class="form-label">å¹… (px)</label>
                                    <input type="number" class="form-control" id="fixedWidth" name="fixed_width" value="300" min="1">
                                </div>
                                <div class="col-md-3">
                                    <label for="fixedHeight" class="form-label">é«˜ã• (px)</label>
                                    <input type="number" class="form-control" id="fixedHeight" name="fixed_height" value="300" min="1">
                                </div>
                            </div>
                            
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-info" onclick="previewCombination()">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</button>
                                <button type="button" class="btn btn-success" onclick="combineImages()">çµåˆå®Ÿè¡Œ</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœ -->
                <div class="card mb-4" id="previewCard" style="display: none;">
                    <div class="card-header">
                        <h5 class="mb-0">4. ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœ</h5>
                    </div>
                    <div class="card-body text-center">
                        <div id="previewContent"></div>
                        <div id="previewInfo" class="mt-3"></div>
                    </div>
                </div>

                <!-- çµåˆçµæœ -->
                <div class="card mb-4" id="resultCard" style="display: none;">
                    <div class="card-header">
                        <h5 class="mb-0">5. çµåˆå®Œäº†</h5>
                    </div>
                    <div class="card-body text-center">
                        <div id="resultContent"></div>
                        <div id="downloadSection" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let selectedImages = [];
        let imageOrder = 0;

        // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—æ©Ÿèƒ½
        const uploadArea = document.getElementById('uploadArea');
        const imageInput = document.getElementById('imageInput');

        uploadArea.addEventListener('click', () => imageInput.click());

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files).filter(file => file.type.startsWith('image/'));
            handleImageFiles(files);
        });

        imageInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            handleImageFiles(files);
        });

        // ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†
        function handleImageFiles(files) {
            files.forEach(file => {
                if (!selectedImages.find(img => img.file.name === file.name && img.file.size === file.size)) {
                    const imageObj = {
                        file: file,
                        id: imageOrder++,
                        url: URL.createObjectURL(file)
                    };
                    selectedImages.push(imageObj);
                }
            });
            updateImageList();
        }

        // ç”»åƒãƒªã‚¹ãƒˆæ›´æ–°
        function updateImageList() {
            const imageList = document.getElementById('imageList');
            const imageCount = document.getElementById('imageCount');
            const imageListCard = document.getElementById('imageListCard');
            const settingsCard = document.getElementById('settingsCard');

            imageCount.textContent = selectedImages.length;

            if (selectedImages.length > 0) {
                imageListCard.style.display = 'block';
                settingsCard.style.display = 'block';
                
                imageList.innerHTML = selectedImages.map((img, index) => `
                    <div class="image-item">
                        <img src="${img.url}" class="image-preview" alt="ç”»åƒ${index + 1}">
                        <button class="remove-btn" onclick="removeImage(${img.id})" title="å‰Šé™¤">Ã—</button>
                        <div style="position: absolute; bottom: -25px; left: 0; right: 0; text-align: center;">
                            <button class="move-btn" onclick="moveImage(${img.id}, -1)" ${index === 0 ? 'disabled' : ''}>â†‘</button>
                            <button class="move-btn" onclick="moveImage(${img.id}, 1)" ${index === selectedImages.length - 1 ? 'disabled' : ''}>â†“</button>
                        </div>
                        <div style="margin-top: 30px; text-align: center; font-size: 12px;">${img.file.name}</div>
                    </div>
                `).join('');
            } else {
                imageListCard.style.display = 'none';
                settingsCard.style.display = 'none';
            }
        }

        // ç”»åƒå‰Šé™¤
        function removeImage(id) {
            selectedImages = selectedImages.filter(img => img.id !== id);
            updateImageList();
        }

        // ç”»åƒé †åºå¤‰æ›´
        function moveImage(id, direction) {
            const index = selectedImages.findIndex(img => img.id === id);
            if (index === -1) return;
            
            const newIndex = index + direction;
            if (newIndex < 0 || newIndex >= selectedImages.length) return;
            
            [selectedImages[index], selectedImages[newIndex]] = [selectedImages[newIndex], selectedImages[index]];
            updateImageList();
        }

        // å…¨ç”»åƒå‰Šé™¤
        function clearImages() {
            selectedImages.forEach(img => URL.revokeObjectURL(img.url));
            selectedImages = [];
            updateImageList();
            document.getElementById('previewCard').style.display = 'none';
            document.getElementById('resultCard').style.display = 'none';
        }

        // è¨­å®šå¤‰æ›´æ™‚ã®è¡¨ç¤ºåˆ¶å¾¡
        document.querySelectorAll('input[name="direction"]').forEach(radio => {
            radio.addEventListener('change', () => {
                document.getElementById('gridSettings').style.display = 
                    radio.value === 'grid' ? 'block' : 'none';
            });
        });

        document.querySelectorAll('input[name="resize_method"]').forEach(radio => {
            radio.addEventListener('change', () => {
                document.getElementById('fixedSizeSettings').style.display = 
                    radio.value === 'fixed' ? 'block' : 'none';
            });
        });

        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ©Ÿèƒ½
        function previewCombination() {
            if (selectedImages.length === 0) {
                alert('ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            performCombination(true);
        }

        // çµåˆå®Ÿè¡Œ
        function combineImages() {
            if (selectedImages.length === 0) {
                alert('ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            performCombination(false);
        }

        // çµåˆå‡¦ç†
        function performCombination(isPreview) {
            const formData = new FormData();
            
            // ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é †åºé€šã‚Šã«è¿½åŠ 
            selectedImages.forEach((img, index) => {
                formData.append('images', img.file);
            });
            
            // è¨­å®šã‚’è¿½åŠ 
            formData.append('direction', document.querySelector('input[name="direction"]:checked').value);
            formData.append('resize_method', document.querySelector('input[name="resize_method"]:checked').value);
            formData.append('grid_cols', document.getElementById('gridCols').value);
            formData.append('fixed_width', document.getElementById('fixedWidth').value);
            formData.append('fixed_height', document.getElementById('fixedHeight').value);
            formData.append('is_preview', isPreview);
            formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

            fetch('{% url "image_combine" %}', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (isPreview) {
                        showPreview(data);
                    } else {
                        showResult(data);
                    }
                } else {
                    alert('ã‚¨ãƒ©ãƒ¼: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            });
        }

        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
        function showPreview(data) {
            const previewCard = document.getElementById('previewCard');
            const previewContent = document.getElementById('previewContent');
            const previewInfo = document.getElementById('previewInfo');
            
            previewContent.innerHTML = `<img src="data:image/jpeg;base64,${data.image_data}" class="combined-preview" alt="ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼">`;
            previewInfo.innerHTML = `
                <p class="text-muted">çµåˆå¾Œã‚µã‚¤ã‚º: ${data.width} Ã— ${data.height} ãƒ”ã‚¯ã‚»ãƒ«</p>
                <div class="mt-3">
                    <div class="row justify-content-center mb-3">
                        <div class="col-md-6">
                            <label for="previewFileName" class="form-label">ãƒ•ã‚¡ã‚¤ãƒ«åï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‹ã‚‰ä¿å­˜ï¼‰</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="previewFileName" value="preview_image" placeholder="ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å…¥åŠ›">
                                <select class="form-select" id="previewFormat" style="max-width: 120px;">
                                    <option value="jpg">.jpg</option>
                                    <option value="png">.png</option>
                                    <option value="bmp">.bmp</option>
                                    <option value="tiff">.tiff</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="downloadFromPreview('${data.image_data}')">
                        <i class="fas fa-download"></i> ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‹ã‚‰ä¿å­˜
                    </button>
                </div>
            `;
            previewCard.style.display = 'block';
        }

        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        function downloadFromPreview(imageData) {
            const fileName = document.getElementById('previewFileName').value || 'preview_image';
            const format = document.getElementById('previewFormat').value;
            const fullFileName = `${fileName}.${format}`;
            
            // ãƒ•ã‚¡ã‚¤ãƒ«åã®æ¤œè¨¼
            if (!fileName.trim()) {
                alert('ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            // ä¸æ­£ãªæ–‡å­—ã‚’ãƒã‚§ãƒƒã‚¯
            const invalidChars = /[<>:"/\\|?*]/;
            if (invalidChars.test(fileName)) {
                alert('ãƒ•ã‚¡ã‚¤ãƒ«åã«ä½¿ç”¨ã§ããªã„æ–‡å­—ãŒå«ã¾ã‚Œã¦ã„ã¾ã™\nä½¿ç”¨ã§ããªã„æ–‡å­—: < > : " / \\ | ? *');
                return;
            }
            
            const link = document.createElement('a');
            link.href = `data:image/${format === 'jpg' ? 'jpeg' : format};base64,${imageData}`;
            link.download = fullFileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // çµæœè¡¨ç¤º
        function showResult(data) {
            const resultCard = document.getElementById('resultCard');
            const resultContent = document.getElementById('resultContent');
            const downloadSection = document.getElementById('downloadSection');
            
            resultContent.innerHTML = `<img src="data:image/jpeg;base64,${data.image_data}" class="combined-preview" alt="çµåˆçµæœ">`;
            downloadSection.innerHTML = `
                <p class="text-success">âœ… ç”»åƒã®çµåˆãŒå®Œäº†ã—ã¾ã—ãŸï¼</p>
                <p class="text-muted">çµåˆå¾Œã‚µã‚¤ã‚º: ${data.width} Ã— ${data.height} ãƒ”ã‚¯ã‚»ãƒ«</p>
                <div class="row justify-content-center mb-3">
                    <div class="col-md-6">
                        <label for="downloadFileName" class="form-label">ãƒ•ã‚¡ã‚¤ãƒ«å</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="downloadFileName" value="combined_image" placeholder="ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å…¥åŠ›">
                            <select class="form-select" id="downloadFormat" style="max-width: 120px;">
                                <option value="jpg">.jpg</option>
                                <option value="png">.png</option>
                                <option value="bmp">.bmp</option>
                                <option value="tiff">.tiff</option>
                            </select>
                        </div>
                    </div>
                </div>
                <button type="button" class="btn btn-primary" onclick="downloadImage('${data.image_data}')">
                    <i class="fas fa-download"></i> ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                </button>
            `;
            resultCard.style.display = 'block';
        }

        // ç”»åƒãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½
        function downloadImage(imageData) {
            const fileName = document.getElementById('downloadFileName').value || 'combined_image';
            const format = document.getElementById('downloadFormat').value;
            const fullFileName = `${fileName}.${format}`;
            
            // ãƒ•ã‚¡ã‚¤ãƒ«åã®æ¤œè¨¼
            if (!fileName.trim()) {
                alert('ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            // ä¸æ­£ãªæ–‡å­—ã‚’ãƒã‚§ãƒƒã‚¯
            const invalidChars = /[<>:"/\\|?*]/;
            if (invalidChars.test(fileName)) {
                alert('ãƒ•ã‚¡ã‚¤ãƒ«åã«ä½¿ç”¨ã§ããªã„æ–‡å­—ãŒå«ã¾ã‚Œã¦ã„ã¾ã™\nä½¿ç”¨ã§ããªã„æ–‡å­—: < > : " / \\ | ? *');
                return;
            }
            
            const link = document.createElement('a');
            link.href = `data:image/${format === 'jpg' ? 'jpeg' : format};base64,${imageData}`;
            link.download = fullFileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>
